name: Makefile CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        # Removed 'upgrade' as it is slow and generally discouraged in CI
        sudo apt-get install -y git gcc build-essential pkg-config binutils wget python3-dev libgmp-dev libmpfr-dev libmpc-dev zlib1g-dev libboost-all-dev texinfo php

    # 1. Try to restore the Ndless directory from cache to save massive build time
    - name: Cache Ndless SDK
      id: cache-ndless
      uses: actions/cache@v3
      with:
        path: Ndless
        # Change 'v1' to 'v2' if you ever need to force a rebuild of the toolchain
        key: ${{ runner.os }}-ndless-sdk-v1

    # 2. If Cache Miss: Clone, Build Toolchain, Build SDK
    - name: Setup Ndless SDK (On Cache Miss)
      if: steps.cache-ndless.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/ndless-nspire/Ndless
        
        # Build the toolchain
        cd Ndless/ndless-sdk/toolchain
        ./build_toolchain.sh
        
        # Go back to Ndless root to build the SDK libs
        cd ../.. 
        
        # We must set PATH locally here because $GITHUB_PATH only updates for *future* steps
        export PATH=$PATH:$(pwd)/ndless-sdk/toolchain/install/bin
        make -j$(nproc)

    # 3. Register the toolchain in the global PATH for all subsequent steps
    - name: Add Ndless to Global PATH
      run: |
        echo "$GITHUB_WORKSPACE/Ndless/ndless-sdk/toolchain/install/bin" >> $GITHUB_PATH
        echo "$GITHUB_WORKSPACE/Ndless/ndless-sdk/bin" >> $GITHUB_PATH

    # 4. Finally make the thing
    - name: Build Project
      run: make -j$(nproc)
